<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat App Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body { font-family: Arial; }
        .section { margin: 20px; padding: 10px; border: 1px solid #ccc; }
        #chat-messages { height: 200px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>
    <div class="section">
        <h2>Регистрация</h2>
        <input id="reg-nickname" placeholder="Nickname" />
        <input id="reg-email" placeholder="Email (optional)" />
        <input id="reg-password" type="password" placeholder="Password" />
        <button onclick="register()">Зарегистрироваться</button>
        <pre id="reg-response"></pre>
    </div>

    <div class="section">
        <h2>Логин</h2>
        <input id="login-nickname" placeholder="Nickname" />
        <input id="login-password" type="password" placeholder="Password" />
        <button onclick="login()">Войти</button>
        <pre id="login-response"></pre>
    </div>

    <div class="section">
        <h2>Создать private чат</h2>
        <input id="private-user2" placeholder="User2 ID" type="number" />
        <button onclick="createPrivateChat()">Создать</button>
        <pre id="private-response"></pre>
    </div>

    <div class="section">
        <h2>Socket.IO Чат</h2>
        <input id="chat-id" placeholder="Chat ID" type="number" />
        <button onclick="joinChat()">Join Room</button>
        <div id="chat-messages"></div>
        <input id="message-content" placeholder="Message" />
        <button onclick="sendMessageSocket()">Отправить через Socket.IO</button>
        <button onclick="sendMessageHTTP()">Отправить через HTTP</button>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let token = localStorage.getItem('token') || '';
        let socket = null;

        async function apiPost(endpoint, body) {
            const response = await fetch(`${API_URL}/${endpoint}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(body)
            });
            return await response.json();
        }

        async function formPost(endpoint, formData) {
            const response = await fetch(`${API_URL}/${endpoint}`, {
                method: 'POST',
                body: formData
            });
            return await response.json();
        }

        async function register() {
            const body = {
                nickname: document.getElementById('reg-nickname').value,
                email: document.getElementById('reg-email').value || null,
                password: document.getElementById('reg-password').value
            };
            const res = await apiPost('register', body);
            document.getElementById('reg-response').innerText = JSON.stringify(res, null, 2);
        }

        async function login() {
            const formData = new FormData();
            formData.append('username', document.getElementById('login-nickname').value);
            formData.append('password', document.getElementById('login-password').value);
            const res = await formPost('token', formData);
            if (res.access_token) {
                token = res.access_token;
                localStorage.setItem('token', token);
                connectSocket();
            }
            document.getElementById('login-response').innerText = JSON.stringify(res, null, 2);
        }

        async function createPrivateChat() {
            const body = { user2_id: parseInt(document.getElementById('private-user2').value) };
            const res = await apiPost('chats', body);
            document.getElementById('private-response').innerText = JSON.stringify(res, null, 2);
        }

        function connectSocket() {
            if (socket) socket.disconnect();
            socket = io(API_URL, {
                auth: { token }
            });

            socket.on('connect', () => console.log('Socket connected'));
            socket.on('disconnect', () => console.log('Socket disconnected'));
            socket.on('new_message', (data) => {
                const msgDiv = document.getElementById('chat-messages');
                msgDiv.innerHTML += `<p>${data.message.user_id}: ${data.message.content}</p>`;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
            socket.on('error', (data) => console.error('Socket error:', data));
        }

        function joinChat() {
            const chatId = document.getElementById('chat-id').value;
            socket.emit('join_room', { chat_id: parseInt(chatId) });
        }

        function sendMessageSocket() {
            const chatId = document.getElementById('chat-id').value;
            const content = document.getElementById('message-content').value;
            socket.emit('send_message', { chat_id: parseInt(chatId), content });
        }

        async function sendMessageHTTP() {
            const chatId = document.getElementById('chat-id').value;
            const content = document.getElementById('message-content').value;
            const body = { content };
            await apiPost(`chats/${chatId}/messages`, body);
        }

        // Auto-connect if token exists
        if (token) connectSocket();
    </script>
</body>
</html>