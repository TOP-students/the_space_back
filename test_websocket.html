<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - The Space</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; display: flex; gap: 20px; }
        .main-content { flex: 2; }
        .sidebar { flex: 1; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { background-color: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #007bff; }
        .input-group { margin: 10px 0; }
        input, button { padding: 8px; margin: 5px; }
        button { background-color: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #messages { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; }
        .online-users { background-color: #e9ecef; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .room-users { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .user-item { padding: 5px; margin: 2px 0; background-color: white; border-radius: 3px; }
        .online { color: #28a745; }
        .offline { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1>üöÄ WebSocket Test - The Space</h1>
            
            <div id="status" class="status disconnected">
                ‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É
            </div>
            
            <div class="input-group">
                <input type="text" id="userNameInput" placeholder="–í–∞—à–µ –∏–º—è" value="User">
                <input type="text" id="roomInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã" value="test_room">
                <button onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
                <button onclick="leaveRoom()">–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
                <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            </div>
            
            <div class="input-group">
                <input type="text" id="fileInput" placeholder="–ò–º—è —Ñ–∞–π–ª–∞" value="test.txt">
                <button onclick="sendFile()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
            </div>
            
            <h3>üì® –°–æ–æ–±—â–µ–Ω–∏—è:</h3>
            <div id="messages"></div>
            
            <button onclick="clearMessages()">–û—á–∏—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</button>
        </div>
        
        <div class="sidebar">
            <div class="online-users">
                <h3>üü¢ –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <button onclick="getOnlineUsers()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="onlineUsersList"></div>
            </div>
            
            <div class="room-users">
                <h3>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ</h3>
                <button onclick="getRoomUsers()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div id="roomUsersList"></div>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let currentRoom = null;
        let currentUserId = null;
        
        function connect() {
            socket = io('http://localhost:8000');
            
            socket.on('connect', () => {
                currentUserId = socket.id;
                updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ—Ä–≤–µ—Ä—É (ID: ' + socket.id + ')', 'connected');
                addMessage('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                getOnlineUsers();
            });
            
            socket.on('disconnect', () => {
                updateStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞', 'disconnected');
                addMessage('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');
            });
            
            socket.on('connected', (data) => {
                addMessage('üîó –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + JSON.stringify(data));
            });
            
            socket.on('user_online', (data) => {
                addMessage('üü¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–Ω–ª–∞–π–Ω: ' + data.user_info.name);
                getOnlineUsers();
            });
            
            socket.on('user_offline', (data) => {
                addMessage('üî¥ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ñ—Ñ–ª–∞–π–Ω: ' + data.user_id);
                getOnlineUsers();
            });
            
            socket.on('joined_room', (data) => {
                currentRoom = data.room_id;
                addMessage('üè† –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ: ' + data.room_id);
                addMessage('üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ: ' + data.users.join(', '));
                getRoomUsers();
            });
            
            socket.on('left_room', (data) => {
                addMessage('üëã –ü–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É: ' + data.room_id);
                currentRoom = null;
                getRoomUsers();
            });
            
            socket.on('new_message', (data) => {
                const userName = data.user_info?.name || data.user_id;
                addMessage('üí¨ ' + userName + ': ' + data.content + ' (' + new Date(data.timestamp).toLocaleTimeString() + ')');
            });
            
            socket.on('new_file', (data) => {
                const userName = data.user_info?.name || data.user_id;
                addMessage('üìÅ ' + userName + ' –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª: ' + data.file_info.name + ' (' + new Date(data.timestamp).toLocaleTimeString() + ')');
            });
            
            socket.on('user_joined_room', (data) => {
                const userName = data.user_info?.name || data.user_id;
                addMessage('üë§ ' + userName + ' –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ');
                getRoomUsers();
            });
            
            socket.on('user_left_room', (data) => {
                addMessage('üëã –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É: ' + data.user_id);
                getRoomUsers();
            });
            
            socket.on('message_sent', (data) => {
                addMessage('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ' + data.content);
            });
            
            socket.on('file_sent', (data) => {
                addMessage('‚úÖ –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ' + data.file_info.name);
            });
            
            socket.on('online_users_list', (data) => {
                updateOnlineUsersList(data);
            });
            
            socket.on('room_users_list', (data) => {
                updateRoomUsersList(data);
            });
            
            socket.on('error', (data) => {
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
            });
        }
        
        function updateStatus(text, className) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + className;
        }
        
        function addMessage(text) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = new Date().toLocaleTimeString() + ' - ' + text;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function joinRoom() {
            const roomId = document.getElementById('roomInput').value;
            const userName = document.getElementById('userNameInput').value;
            if (socket && roomId) {
                socket.emit('join_room', {
                    room_id: roomId,
                    user_info: { name: userName, role: 'user' }
                });
            }
        }
        
        function leaveRoom() {
            if (socket && currentRoom) {
                socket.emit('leave_room', { room_id: currentRoom });
            }
        }
        
        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (socket && currentRoom && message) {
                socket.emit('send_message', {
                    room_id: currentRoom,
                    content: message
                });
                document.getElementById('messageInput').value = '';
            }
        }
        
        function sendFile() {
            const fileName = document.getElementById('fileInput').value;
            if (socket && currentRoom && fileName) {
                socket.emit('send_file', {
                    room_id: currentRoom,
                    file_info: {
                        name: fileName,
                        url: 'https://example.com/' + fileName,
                        size: 1024,
                        type: 'text/plain'
                    }
                });
            }
        }
        
        function getOnlineUsers() {
            if (socket) {
                socket.emit('get_online_users_ws', {});
            }
        }
        
        function getRoomUsers() {
            if (socket && currentRoom) {
                socket.emit('get_room_users', { room_id: currentRoom });
            }
        }
        
        function updateOnlineUsersList(data) {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '<p>–í—Å–µ–≥–æ –æ–Ω–ª–∞–π–Ω: ' + data.total_online + '</p>';
            
            Object.entries(data.users_info).forEach(([userId, userInfo]) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item online';
                userDiv.innerHTML = userInfo.name + ' (' + userId.substring(0, 8) + '...)';
                container.appendChild(userDiv);
            });
        }
        
        function updateRoomUsersList(data) {
            const container = document.getElementById('roomUsersList');
            container.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –∫–æ–º–Ω–∞—Ç–µ: ' + data.total_users + '</p>';
            
            Object.entries(data.users_info).forEach(([userId, userInfo]) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item online';
                userDiv.innerHTML = userInfo.name + ' (' + userId.substring(0, 8) + '...)';
                container.appendChild(userDiv);
            });
        }
        
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }
        
        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            connect();
        };
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html> 